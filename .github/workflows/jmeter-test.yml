name: Jmeter

on:
  workflow_dispatch:
  push:
    branches: [ claimname-temp ]
  pull_request:
    branches: [ master ]

jobs:
  jmeter-test:
    name: jmeter-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: docker/setup-buildx-action@v2
        with: {install: true}

      - uses: docker/build-push-action@v4
        with:
          tags: assetmantle/node:edge
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            TARGETARCH=amd64
            BUILDARCH=amd64

      - run: make docker-compose

      # - name: jmeter test
      #   uses: rbhadti94/apache-jmeter-action@v0.5.0
      #   with:
      #     testFilePath: .jmeter/jmeter.jmx
      #     outputReportsFolder: reports/

      - name: jmeter test1
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames1.jmx
          outputReportsFolder: reports/
      - name: jmeter test2
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames2.jmx
          outputReportsFolder: reports/
      - name: jmeter test3
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames3.jmx
          outputReportsFolder: reports/
      - name: jmeter test4
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames4.jmx
          outputReportsFolder: reports/
      - name: jmeter test5
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames5.jmx
          outputReportsFolder: reports/
      - name: jmeter test6
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames6.jmx
          outputReportsFolder: reports/
      - name: jmeter test7
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames7.jmx
          outputReportsFolder: reports/
      - name: jmeter test8
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames8.jmx
          outputReportsFolder: reports/
      - name: jmeter test9
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames9.jmx
          outputReportsFolder: reports/
      - name: jmeter test10
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: .jmeter/ClaimNames10.jmx
          outputReportsFolder: reports/

      - run: make docker-compose-clean || true
        if: ${{ always() }}

      - uses: actions/upload-artifact@v3
        with:
          name: jmeter-report
          path: reports/
